name: Deploy to VPS
# Automated deployment on push to main

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to VPS
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_SSH_PORT }}
          script: |
            set -e
            
            PROJECT_DIR="/home/rei/greenhouse"
            PROJECT_TMP="/home/rei/greenhouse-tmp"
            TIMESTAMP=$(date +%Y%m%d_%H%M%S)
            DEPLOY_LOG="/home/rei/greenhouse/logs/deploy_${TIMESTAMP}.log"
            
            # Crear directorio de logs si no existe
            mkdir -p "$(dirname "$DEPLOY_LOG")"
            
            {
              echo "ðŸš€ ===== DEPLOYMENT INICIADO ====="
              echo "Timestamp: $TIMESTAMP"
              echo "Repositorio: https://github.com/reimonlp/greenhouse"
              echo ""
              
              # 1. Clonar repositorio fresco
              echo "ðŸ“¥ Paso 1: Clonando repositorio..."
              if [ -d "$PROJECT_TMP" ]; then
                rm -rf "$PROJECT_TMP"
              fi
              git clone https://github.com/reimonlp/greenhouse.git "$PROJECT_TMP" --quiet
              cd "$PROJECT_TMP"
              CURRENT_COMMIT=$(git rev-parse HEAD)
              echo "âœ… Clone completado: ${CURRENT_COMMIT:0:7}"
              echo ""
              
              # 2. Restaurar archivos de configuraciÃ³n desde proyecto anterior
              echo "ðŸ” Paso 2: Restaurando archivos de configuraciÃ³n..."
              if [ -f "$PROJECT_DIR/.env.production" ]; then
                cp "$PROJECT_DIR/.env.production" "$PROJECT_TMP/.env.production"
                cp "$PROJECT_DIR/.env.production" "$PROJECT_TMP/backend/.env"
                cp "$PROJECT_DIR/.env.production" "$PROJECT_TMP/docker/.env.production"
                echo "   âœ… .env restaurados"
              else
                echo "   Creando .env desde GitHub Secrets..."
                echo '${{ secrets.ENV_PRODUCTION }}' > "$PROJECT_TMP/.env.production"
                cp "$PROJECT_TMP/.env.production" "$PROJECT_TMP/backend/.env"
                cp "$PROJECT_TMP/.env.production" "$PROJECT_TMP/docker/.env.production"
              fi
              
              # Restaurar secrets.h del ESP32
              if [ -f "$PROJECT_DIR/esp32-firmware/include/secrets.h" ]; then
                cp "$PROJECT_DIR/esp32-firmware/include/secrets.h" "$PROJECT_TMP/esp32-firmware/include/secrets.h"
                echo "   âœ… ESP32 secrets.h restaurado"
              fi
              
              echo ""
              # Verificar que es un repositorio git vÃ¡lido
              if [ ! -d ".git" ]; then
                echo "âš ï¸  Directorio .git no encontrado, reinitializando repositorio..."
                git init
                git remote add origin https://github.com/reimonlp/greenhouse.git
              fi
              
              CURRENT_COMMIT=$(git rev-parse HEAD 2>/dev/null || echo "unknown")
              git fetch origin main
              git reset --hard origin/main
              NEW_COMMIT=$(git rev-parse HEAD)
              
              if [ "$CURRENT_COMMIT" = "$NEW_COMMIT" ]; then
                echo "âš ï¸  No hay cambios nuevos (ya estaba al dÃ­a)"
              else
                echo "âœ… Git pull completado"
                echo "   Commit anterior: ${CURRENT_COMMIT:0:7}"
                echo "   Commit nuevo: ${NEW_COMMIT:0:7}"
              fi
              echo ""
              
              # 3. Validar configuraciÃ³n Docker
              echo "ðŸ” Paso 3: Validando docker-compose.prod.yml..."
              docker compose -f docker/docker-compose.prod.yml config > /dev/null
              echo "âœ… ConfiguraciÃ³n validada"
              echo ""
              
              # 4. Reemplazar proyecto actual
              echo "ðŸ”„ Paso 4: Activando nuevo cÃ³digo..."
              cd /home/rei
              
              # Limpiar directorio anterior si existe
              if [ -d "$PROJECT_DIR.old" ]; then
                sudo rm -rf "$PROJECT_DIR.old"
              fi
              
              # Renombrar actual como .old (para rollback)
              if [ -d "$PROJECT_DIR" ]; then
                mv "$PROJECT_DIR" "$PROJECT_DIR.old"
              fi
              
              # Activar nuevo cÃ³digo
              mv "$PROJECT_TMP" "$PROJECT_DIR"
              echo "âœ… CÃ³digo actualizado"
              echo ""
              
              # 5. Reiniciar backend
              echo "ðŸ”„ Paso 5: Construyendo e iniciando backend..."
              
              # Build Docker image
              echo "   Building Docker image..."
              docker compose -f docker/docker-compose.prod.yml build app 2>&1 | grep -E "^(Step|Successfully|ERROR)" || true
              
              # Start backend
              docker compose -f docker/docker-compose.prod.yml down app 2>/dev/null || true
              docker compose -f docker/docker-compose.prod.yml up -d app
              echo "âœ… Backend iniciado"
              echo ""
              
              # 6. Health checks (con reintentos)
              echo "ðŸ¥ Paso 6: Verificando salud de servicios..."
              sleep 15  # Wait for backend to fully start
              MAX_RETRIES=5
              RETRY=0
              HEALTH_OK=false
              
              while [ $RETRY -lt $MAX_RETRIES ]; do
                if curl -sf https://reimon.dev/greenhouse/health > /dev/null 2>&1; then
                  echo "âœ… Backend health check PASSED"
                  HEALTH_OK=true
                  break
                else
                  RETRY=$((RETRY + 1))
                  if [ $RETRY -lt $MAX_RETRIES ]; then
                    echo "â³ Reintento $RETRY/$MAX_RETRIES en 3s..."
                    sleep 3
                  fi
                fi
              done
              
              if [ "$HEALTH_OK" = false ]; then
                echo "âŒ Backend health check FALLÃ“"
                echo "ðŸ”™ Iniciando rollback..."
                
                # Rollback: restaurar versiÃ³n anterior
                cd /home/rei
                docker compose -f "$PROJECT_DIR/docker/docker-compose.prod.yml" down app 2>/dev/null || true
                sudo rm -rf "$PROJECT_DIR"
                [ -d "$PROJECT_DIR.old" ] && mv "$PROJECT_DIR.old" "$PROJECT_DIR"
                cd "$PROJECT_DIR"
                docker compose -f docker/docker-compose.prod.yml up -d app
                
                sleep 5
                if curl -sf https://reimon.dev/greenhouse/health > /dev/null 2>&1; then
                  echo "âœ… Rollback completado - servicios restaurados"
                else
                  echo "âŒ CRÃTICO: Rollback fallÃ³ - revisar manualmente"
                  exit 1
                fi
              fi
              echo ""
              
              # 7. Limpiar
              echo "ðŸ§¹ Paso 7: Limpiando..."
              sudo rm -rf "$PROJECT_DIR.old"
              echo "âœ… Limpieza completada"
              echo ""
              
              # 8. Resumen final
              echo "âœ¨ ===== DEPLOYMENT COMPLETADO ====="
              echo "Estado: EXITOSO"
              echo "Servicios activos:"
              docker compose -f docker/docker-compose.prod.yml ps
              echo ""
              echo "Logs guardados en: $DEPLOY_LOG"
              
            } 2>&1 | tee "$DEPLOY_LOG"
            
            # Guardar log en carpeta accesible
            cp "$DEPLOY_LOG" "$PROJECT_DIR/logs/deploy_${TIMESTAMP}.log" 2>/dev/null || true
