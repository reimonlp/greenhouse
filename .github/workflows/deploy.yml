name: Deploy to VPS
# Automated deployment on push to main

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to VPS
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_SSH_PORT }}
          script: |
            set -e
            
            PROJECT_DIR="/home/rei/greenhouse"
            BACKUP_DIR="/home/rei/greenhouse-backup"
            TIMESTAMP=$(date +%Y%m%d_%H%M%S)
            DEPLOY_LOG="/tmp/deploy_${TIMESTAMP}.log"
            
            # Preservar archivos sensibles
            ENV_BACKUP_DIR="/tmp/env_backup_${TIMESTAMP}"
            mkdir -p "$ENV_BACKUP_DIR"
            
            {
              echo "ðŸš€ ===== DEPLOYMENT INICIADO ====="
              echo "Timestamp: $TIMESTAMP"
              echo "Proyecto: $PROJECT_DIR"
              echo ""
              
              # Asegurar permisos correctos en el directorio del proyecto
              chmod -R u+w "$PROJECT_DIR" 2>/dev/null || true
              
              # 0. Crear archivos .env desde GitHub Secrets
              echo "ðŸ” Paso 0: Configurando variables de entorno..."
              
              # Crear .env.production en raÃ­z
              echo '${{ secrets.ENV_PRODUCTION }}' > "$PROJECT_DIR/.env.production"
              chmod 644 "$PROJECT_DIR/.env.production"
              
              # Copiar a backend y docker (usando tee para evitar problemas de permisos)
              cat "$PROJECT_DIR/.env.production" | tee "$PROJECT_DIR/backend/.env" > /dev/null
              cat "$PROJECT_DIR/.env.production" | tee "$PROJECT_DIR/docker/.env.production" > /dev/null
              chmod 644 "$PROJECT_DIR/backend/.env" "$PROJECT_DIR/docker/.env.production" 2>/dev/null || true
              
              # Preservar token ESP32 en secrets.h si existe
              if grep -q "ESP32_AUTH_TOKEN" "$PROJECT_DIR/esp32-firmware/include/secrets.h" 2>/dev/null; then
                echo "   â„¹ï¸  ESP32 secrets.h preservado"
              fi
              
              echo "âœ… Variables de entorno configuradas"
              echo ""
              
              # 1. Crear backup del estado actual (excluyendo node_modules, dist, logs)
              echo "ðŸ“¦ Paso 1: Creando backup..."
              
              # Preservar archivos .env y secrets
              echo "   Preservando archivos de configuraciÃ³n..."
              [ -f "$PROJECT_DIR/.env.production" ] && cp "$PROJECT_DIR/.env.production" "$ENV_BACKUP_DIR/"
              [ -f "$PROJECT_DIR/backend/.env" ] && cp "$PROJECT_DIR/backend/.env" "$ENV_BACKUP_DIR/"
              [ -f "$PROJECT_DIR/docker/.env.production" ] && cp "$PROJECT_DIR/docker/.env.production" "$ENV_BACKUP_DIR/"
              [ -f "$PROJECT_DIR/esp32-firmware/include/secrets.h" ] && cp "$PROJECT_DIR/esp32-firmware/include/secrets.h" "$ENV_BACKUP_DIR/"
              
              if [ -d "$BACKUP_DIR" ]; then
                rm -rf "$BACKUP_DIR"
              fi
              rsync -av --exclude='node_modules' --exclude='dist' --exclude='logs' --exclude='.git' "$PROJECT_DIR/" "$BACKUP_DIR/"
              echo "âœ… Backup completado: $BACKUP_DIR"
              echo ""
              
              # 2. Git pull
              echo "ðŸ“¥ Paso 2: Actualizando repositorio..."
              cd "$PROJECT_DIR"
              
              # Verificar que es un repositorio git vÃ¡lido
              if [ ! -d ".git" ]; then
                echo "âš ï¸  Directorio .git no encontrado, reinitializando repositorio..."
                git init
                git remote add origin https://github.com/reimonlp/greenhouse.git
              fi
              
              CURRENT_COMMIT=$(git rev-parse HEAD 2>/dev/null || echo "unknown")
              git fetch origin main
              git reset --hard origin/main
              NEW_COMMIT=$(git rev-parse HEAD)
              
              if [ "$CURRENT_COMMIT" = "$NEW_COMMIT" ]; then
                echo "âš ï¸  No hay cambios nuevos (ya estaba al dÃ­a)"
              else
                echo "âœ… Git pull completado"
                echo "   Commit anterior: ${CURRENT_COMMIT:0:7}"
                echo "   Commit nuevo: ${NEW_COMMIT:0:7}"
              fi
              echo ""
              
              # 3. Validar configuraciÃ³n Docker
              echo "ðŸ” Paso 3: Validando docker-compose.prod.yml..."
              docker compose -f docker/docker-compose.prod.yml config > /dev/null
              echo "âœ… ConfiguraciÃ³n validada"
              echo ""
              
              # 4. Reiniciar backend (sin MongoDB)
              echo "ðŸ”„ Paso 4: Reiniciando backend..."
              docker compose -f docker/docker-compose.prod.yml up -d app 2>&1 | tee -a "$DEPLOY_LOG"
              echo "âœ… Backend reiniciado"
              echo ""
              
              # 5. Si Nginx estÃ¡ en Docker, reiniciarlo (opcional)
              # docker compose -f docker/docker-compose.prod.yml up -d web 2>&1 | tee -a "$DEPLOY_LOG"
              echo "âœ… Frontend (Nginx del sistema) estÃ¡ listo"
              echo ""
              
              # 6. Health checks (con reintentos)
              echo "ðŸ¥ Paso 6: Verificando salud de servicios..."
              MAX_RETRIES=5
              RETRY=0
              HEALTH_OK=false
              
              while [ $RETRY -lt $MAX_RETRIES ]; do
                # Health check a travÃ©s de Nginx en el host
                if curl -sf https://reimon.dev/health > /dev/null 2>&1; then
                  echo "âœ… Backend health check PASSED (vÃ­a Nginx)"
                  HEALTH_OK=true
                  break
                else
                  RETRY=$((RETRY + 1))
                  if [ $RETRY -lt $MAX_RETRIES ]; then
                    echo "â³ Reintento $RETRY/$MAX_RETRIES en 3s..."
                    sleep 3
                  fi
                fi
              done
              
              if [ "$HEALTH_OK" = false ]; then
                echo "âŒ Backend health check FALLÃ“ despuÃ©s de $MAX_RETRIES intentos"
                echo "ðŸ”™ Iniciando rollback..."
                
                # Rollback: restaurar desde backup
                cd /home/rei
                echo "   Limpiando directorio actual..."
                # Borrar solo archivos de cÃ³digo, no directorios del sistema
                find "$PROJECT_DIR" -maxdepth 1 -type f -delete 2>/dev/null || true
                find "$PROJECT_DIR" -maxdepth 1 -type d ! -name '.' ! -name '..' ! -name 'logs' ! -name 'backups' -exec rm -rf {} + 2>/dev/null || true
                
                # Restaurar desde backup
                echo "   Restaurando cÃ³digo desde backup..."
                rsync -av --delete "$BACKUP_DIR/" "$PROJECT_DIR/" 2>/dev/null || cp -r "$BACKUP_DIR"/* "$PROJECT_DIR/" 2>/dev/null || true
                
                cd "$PROJECT_DIR"
                
                # Restaurar archivos .env preservados
                echo "   Restaurando configuraciÃ³n..."
                [ -f "$ENV_BACKUP_DIR/.env.production" ] && cp "$ENV_BACKUP_DIR/.env.production" "$PROJECT_DIR/.env.production" || true
                [ -f "$ENV_BACKUP_DIR/.env" ] && cp "$ENV_BACKUP_DIR/.env" "$PROJECT_DIR/backend/.env" || true
                [ -f "$ENV_BACKUP_DIR/.env.production" ] && cp "$ENV_BACKUP_DIR/.env.production" "$PROJECT_DIR/docker/.env.production" || true
                [ -f "$ENV_BACKUP_DIR/secrets.h" ] && mkdir -p "$PROJECT_DIR/esp32-firmware/include" && cp "$ENV_BACKUP_DIR/secrets.h" "$PROJECT_DIR/esp32-firmware/include/" || true
                
                # Reiniciar con versiÃ³n anterior
                echo "   Reiniciando servicios..."
                docker compose -f docker/docker-compose.prod.yml restart app 2>/dev/null || docker compose -f docker/docker-compose.prod.yml up -d app
                
                sleep 5
                if curl -sf https://reimon.dev/health > /dev/null 2>&1; then
                  echo "âœ… Rollback completado - servicios restaurados"
                else
                  echo "âŒ CRÃTICO: Rollback fallÃ³ - revisar manualmente"
                  exit 1
                fi
              fi
              echo ""
              
              # 7. Limpiar backup si todo OK
              echo "ðŸ§¹ Paso 7: Limpiando..."
              rm -rf "$BACKUP_DIR"
              rm -rf "$ENV_BACKUP_DIR"
              echo "âœ… Backup temporal eliminado"
              echo ""
              
              # 8. Resumen final
              echo "âœ¨ ===== DEPLOYMENT COMPLETADO ====="
              echo "Estado: EXITOSO"
              echo "Servicios activos:"
              docker compose -f docker/docker-compose.prod.yml ps
              echo ""
              echo "Logs disponibles en: $DEPLOY_LOG"
              
            } 2>&1 | tee "$DEPLOY_LOG"
            
            # Guardar log en carpeta accesible
            cp "$DEPLOY_LOG" "$PROJECT_DIR/logs/deploy_${TIMESTAMP}.log" 2>/dev/null || true
