<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Greenhouse - Control System</title>
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    <link rel="stylesheet" href="/style.css">
    <meta name="theme-color" content="#10b981">
    <meta name="description" content="Greenhouse Control System - Monitor and control your greenhouse environment">
</head>
<body>
    <!-- Icon sprite (external) -->
    <link rel="preload" href="/icons.svg" as="image">

    <!-- Mobile Top Tabs -->
    <nav class="top-tabs" aria-label="Secciones">
        <button class="top-tab active" data-view="dht" title="DHT11">
            <svg viewBox="0 0 24 24"><use href="/icons.svg#i-dht"></use></svg>
            <span>DHT11</span>
        </button>
        <button class="top-tab" data-view="soil" title="Suelo">
            <svg viewBox="0 0 24 24"><use href="/icons.svg#i-soil"></use></svg>
            <span>Suelo</span>
        </button>
        <button class="top-tab" data-view="luces" title="Luces">
            <svg viewBox="0 0 24 24"><use href="/icons.svg#i-light"></use></svg>
            <span>Luces</span>
        </button>
        <button class="top-tab" data-view="ventilador" title="Ventilador">
            <svg viewBox="0 0 24 24"><use href="/icons.svg#i-fan"></use></svg>
            <span>Ventilador</span>
        </button>
        <button class="top-tab" data-view="bomba" title="Bomba">
            <svg viewBox="0 0 24 24"><use href="/icons.svg#i-pump"></use></svg>
            <span>Bomba</span>
        </button>
        <button class="top-tab" data-view="calefactor" title="Calefactor">
            <svg viewBox="0 0 24 24"><use href="/icons.svg#i-heater"></use></svg>
            <span>Calefactor</span>
        </button>
        <button class="top-tab" data-view="system" title="Sistema">
            <svg viewBox="0 0 24 24"><use href="/icons.svg#i-settings"></use></svg>
            <span>Sistema</span>
        </button>
        <button class="top-tab" data-view="logs" title="Logs">
            <svg viewBox="0 0 24 24"><use href="/icons.svg#i-logs"></use></svg>
            <span>Logs</span>
        </button>
    </nav>
    <!-- Sidebar Navigation (acts as tab list) -->
    <nav class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="logo">
                <svg class="logo-icon" viewBox="0 0 24 24">
                    <use href="/icons.svg#i-greenhouse"></use>
                </svg>
                <h1 class="logo-text">Greenhouse</h1>
            </div>
            <button class="sidebar-toggle" id="sidebarToggle" aria-label="Toggle sidebar">
                <svg viewBox="0 0 24 24">
                    <use href="/icons.svg#i-settings"></use>
                </svg>
            </button>
        </div>
        
        <ul class="nav-menu">
            <li class="nav-item active" data-view="dht">
                <svg class="nav-icon" viewBox="0 0 24 24"><use href="/icons.svg#i-dht"></use></svg>
                <span class="nav-text">DHT11</span>
            </li>
            <li class="nav-item" data-view="soil">
                <svg class="nav-icon" viewBox="0 0 24 24"><use href="/icons.svg#i-soil"></use></svg>
                <span class="nav-text">Suelo</span>
            </li>
            <li class="nav-item" data-view="luces">
                <svg class="nav-icon" viewBox="0 0 24 24"><use href="/icons.svg#i-light"></use></svg>
                <span class="nav-text">Luces</span>
            </li>
            <li class="nav-item" data-view="ventilador">
                <svg class="nav-icon" viewBox="0 0 24 24"><use href="/icons.svg#i-fan"></use></svg>
                <span class="nav-text">Ventilador</span>
            </li>
            <li class="nav-item" data-view="bomba">
                <svg class="nav-icon" viewBox="0 0 24 24"><use href="/icons.svg#i-pump"></use></svg>
                <span class="nav-text">Bomba</span>
            </li>
            <li class="nav-item" data-view="calefactor">
                <svg class="nav-icon" viewBox="0 0 24 24"><use href="/icons.svg#i-heater"></use></svg>
                <span class="nav-text">Calefactor</span>
            </li>
            <li class="nav-item" data-view="system">
                <svg class="nav-icon" viewBox="0 0 24 24"><use href="/icons.svg#i-settings"></use></svg>
                <span class="nav-text">Sistema</span>
            </li>
            <li class="nav-item" data-view="logs">
                <svg class="nav-icon" viewBox="0 0 24 24"><use href="/icons.svg#i-logs"></use></svg>
                <span class="nav-text">Logs</span>
            </li>
        </ul>

        <div class="sidebar-footer">
            <div class="connection-status" id="connectionStatus">
                <div class="status-indicator" id="statusIndicator"></div>
                <span class="status-text" id="statusText">Conectando...</span>
            </div>
            <button class="btn-icon" id="authBtn" title="Autenticación API">
                <svg viewBox="0 0 24 24"><use href="/icons.svg#i-key"></use></svg>
            </button>
            <span id="authStatus" class="auth-status" style="margin-left:auto; font-size:0.85rem; color: var(--text-secondary);">No auth</span>
            <button class="btn-icon" id="logoutBtn" title="Cerrar sesión" style="display:none;">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
                    <path d="M16 17l5-5-5-5"/>
                    <path d="M21 12H9"/>
                </svg>
            </button>
        </div>
    </nav>

    <!-- Main Content Area -->
    <main class="main-content">
      <div class="app-card">
        <!-- Global Alert Bar -->
        <div class="alert-bar" id="alertBar" style="display:none;">
            <svg class="alert-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"/>
                <line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/>
            </svg>
            <span class="alert-message" id="alertMessage"></span>
            <button class="alert-close-btn" id="alertCloseBtn">×</button>
        </div>

        

            <!-- VIEW: Suelo (humedad de suelo) -->
            <section class="view" data-view="soil">
                <div class="card">
                    <div class="card-header"><h3 class="card-title">Humedad de Suelo</h3></div>
                    <div class="card-body">
                        <div class="info-list">
                            <div class="info-item"><span class="info-label">Sensor 1</span><span class="info-value" id="soil1_soil">--%</span></div>
                            <div class="info-item"><span class="info-label">Sensor 2</span><span class="info-value" id="soil2_soil">--%</span></div>
                            <div class="info-item"><span class="info-label">Estado Suelo</span><span class="info-value" id="soil_status_soil">🔴</span></div>
                        </div>
                    </div>
                </div>
            </section>

        

            <!-- VIEW: DHT11 (info ambiental) -->
            <section class="view" data-view="dht">
                <div class="card">
                    <div class="card-header"><h3 class="card-title">Estado Ambiental (DHT11)</h3></div>
                    <div class="card-body">
                        <div class="info-list">
                            <div class="info-item"><span class="info-label">Temperatura</span><span class="info-value" id="temperature_dht">--°C</span></div>
                            <div class="info-item"><span class="info-label">Humedad</span><span class="info-value" id="humidity_dht">--%</span></div>
                            <div class="info-item"><span class="info-label">Estado DHT</span><span class="info-value" id="dht_status_dht">🔴</span></div>
                        </div>
                    </div>
                </div>
            </section>

            

            <!-- VIEW: Luces -->
            <section class="view" data-view="luces">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">
                            <svg viewBox="0 0 24 24" style="width:1.5rem;height:1.5rem;"><use href="/icons.svg#i-light"></use></svg>
                            Luces
                        </h3>
                        <button class="btn btn-secondary" id="refreshLuces">Refresh</button>
                    </div>
                    <div class="card-body">
                        <!-- Manual Control -->
                        <div class="relay-control">
                            <div class="relay-status">
                                <span class="relay-indicator" id="lucesIndicator">⚫</span>
                                <span id="lucesStatus">Cargando...</span>
                            </div>
                            <label class="switch">
                                <input type="checkbox" id="lucesToggle">
                                <span class="slider"></span>
                            </label>
                        </div>
                        <!-- Mode selector -->
                        <div class="mode-selector">
                            <label>Modo:</label>
                            <select id="lucesMode" class="input-field">
                                <option value="manual">Manual</option>
                                <option value="auto">Automático</option>
                            </select>
                        </div>
                        <!-- Rules section (only visible in auto mode) -->
                        <div class="rules-section" id="lucesRules" style="display:none;">
                            <h4>Reglas Automáticas</h4>
                            <div class="rules-list" id="lucesRulesList">
                                <p class="text-secondary">Sin reglas configuradas</p>
                            </div>
                            <div style="display: flex; gap: 0.5rem;">
                                <button class="btn btn-primary" id="lucesAddRule">+ Agregar Regla</button>
                                <button class="btn btn-outline" onclick="relayManager.clearAllRules(0)">🗑️ Limpiar Todo</button>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- VIEW: Ventilador -->
            <section class="view" data-view="ventilador">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">
                            <svg viewBox="0 0 24 24" style="width:1.5rem;height:1.5rem;"><use href="/icons.svg#i-fan"></use></svg>
                            Ventilador
                        </h3>
                        <button class="btn btn-secondary" id="refreshVentilador">Refresh</button>
                    </div>
                    <div class="card-body">
                        <div class="relay-control">
                            <div class="relay-status">
                                <span class="relay-indicator" id="ventiladorIndicator">⚫</span>
                                <span id="ventiladorStatus">Cargando...</span>
                            </div>
                            <label class="switch">
                                <input type="checkbox" id="ventiladorToggle">
                                <span class="slider"></span>
                            </label>
                        </div>
                        <div class="mode-selector">
                            <label>Modo:</label>
                            <select id="ventiladorMode" class="input-field">
                                <option value="manual">Manual</option>
                                <option value="auto">Automático</option>
                            </select>
                        </div>
                                                <!-- Rules section (only visible in auto mode) -->
                        <div class="rules-section" id="ventiladorRules" style="display:none;">
                            <h4>Reglas Automáticas</h4>
                            <div class="rules-list" id="ventiladorRulesList">
                                <p class="text-secondary">Sin reglas configuradas</p>
                            </div>
                            <div style="display: flex; gap: 0.5rem;">
                                <button class="btn btn-primary" id="ventiladorAddRule">+ Agregar Regla</button>
                                <button class="btn btn-outline" onclick="relayManager.clearAllRules(1)">🗑️ Limpiar Todo</button>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- VIEW: Bomba -->
            <section class="view" data-view="bomba">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">
                            <svg viewBox="0 0 24 24" style="width:1.5rem;height:1.5rem;"><use href="/icons.svg#i-pump"></use></svg>
                            Bomba de Riego
                        </h3>
                        <button class="btn btn-secondary" id="refreshBomba">Refresh</button>
                    </div>
                    <div class="card-body">
                        <div class="relay-control">
                            <div class="relay-status">
                                <span class="relay-indicator" id="bombaIndicator">⚫</span>
                                <span id="bombaStatus">Cargando...</span>
                            </div>
                            <label class="switch">
                                <input type="checkbox" id="bombaToggle">
                                <span class="slider"></span>
                            </label>
                        </div>
                        <div class="mode-selector">
                            <label>Modo:</label>
                            <select id="bombaMode" class="input-field">
                                <option value="manual">Manual</option>
                                <option value="auto">Automático</option>
                            </select>
                        </div>
                        <div class="rules-section" id="bombaRules" style="display:none;">
                            <h4>Reglas Automáticas</h4>
                            <div class="rules-list" id="bombaRulesList">
                                <p class="text-secondary">Sin reglas configuradas</p>
                            </div>
                            <div style="display: flex; gap: 0.5rem;">
                                <button class="btn btn-primary" id="bombaAddRule">+ Agregar Regla</button>
                                <button class="btn btn-outline" onclick="relayManager.clearAllRules(2)">🗑️ Limpiar Todo</button>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- VIEW: Calefactor -->
            <section class="view" data-view="calefactor">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">
                            <svg viewBox="0 0 24 24" style="width:1.5rem;height:1.5rem;"><use href="/icons.svg#i-heater"></use></svg>
                            Calefactor
                        </h3>
                        <button class="btn btn-secondary" id="refreshCalefactor">Refresh</button>
                    </div>
                    <div class="card-body">
                        <div class="relay-control">
                            <div class="relay-status">
                                <span class="relay-indicator" id="calefactorIndicator">⚫</span>
                                <span id="calefactorStatus">Cargando...</span>
                            </div>
                            <label class="switch">
                                <input type="checkbox" id="calefactorToggle">
                                <span class="slider"></span>
                            </label>
                        </div>
                        <div class="mode-selector">
                            <label>Modo:</label>
                            <select id="calefactorMode" class="input-field">
                                <option value="manual">Manual</option>
                                <option value="auto">Automático</option>
                            </select>
                        </div>
                        <div class="rules-section" id="calefactorRules" style="display:none;">
                            <h4>Reglas Automáticas</h4>
                            <div class="rules-list" id="calefactorRulesList">
                                <p class="text-secondary">Sin reglas configuradas</p>
                            </div>
                            <div style="display: flex; gap: 0.5rem;">
                                <button class="btn btn-primary" id="calefactorAddRule">+ Agregar Regla</button>
                                <button class="btn btn-outline" onclick="relayManager.clearAllRules(3)">🗑️ Limpiar Todo</button>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- VIEW: System (compact single card list) -->
            <section class="view" data-view="system">
              <div class="card">
                <div class="card-header">
                  <h3 class="card-title">Información del Sistema</h3>
                  <button class="btn btn-secondary" id="refreshSystemBtn">Refresh</button>
                </div>
                <div class="card-body">
                  <div class="info-list">
                    <div class="info-item"><span class="info-label">Free Heap</span><span class="info-value" id="freeHeap">--</span></div>
                    <div class="info-item"><span class="info-label">Fragmentación</span><span class="info-value" id="fragmentation">--%</span></div>
                    <div class="info-item"><span class="info-label">Estado Red</span><span class="info-value" id="networkStatus">--</span></div>
                    <div class="info-item"><span class="info-label">Señal</span><span class="info-value" id="signalStrength">-- dBm</span></div>
                    <div class="info-item"><span class="info-label">Reintentos WiFi</span><span class="info-value" id="reconnectCount">--</span></div>
                    <div class="info-item"><span class="info-label">Loop Avg</span><span class="info-value" id="loopAvg">-- μs</span></div>
                    <div class="info-item"><span class="info-label">Estado</span><span class="info-value" id="systemState">--</span></div>
                  </div>
                </div>
              </div>
            </section>

                        <!-- VIEW: Logs (list, compact) -->
                        <section class="view" data-view="logs">
                            <div class="card">
                                <div class="card-header">
                                    <h3 class="card-title">Logs del sistema</h3>
                                    <div class="actions">
                                        <select id="logsFilter" class="input-field" style="min-width: 9rem;">
                                            <option value="all">Todos</option>
                                            <option value="warn+">Warn+</option>
                                            <option value="error+">Error+</option>
                                            <option value="crit">Críticos</option>
                                        </select>
                                        <button class="btn btn-secondary" id="refreshLogs">Refresh</button>
                                        <button class="btn btn-secondary" id="exportLogs">Exportar</button>
                                        <button class="btn btn-danger" id="clearLogs">Limpiar</button>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div id="logsList" class="log-list" style="max-height: 46vh; overflow:auto; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace; font-size: 0.9rem; line-height: 1.3;"></div>
                                </div>
                            </div>
                        </section>
            </div>
        </main>

        <!-- Footer (hidden on small screens to avoid overflow) -->
        <footer class="main-footer">
            <div class="footer-info">
                <span>Greenhouse Control System v3.0</span>
                <span>Last data: <span id="lastDataTime">Never</span></span>
            </div>
    </footer>


    <!-- Authentication Modal -->
    <div class="modal-overlay" id="authModal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>API Authentication</h3>
                <button class="modal-close" id="modalCloseBtn">×</button>
            </div>
            <div class="modal-body">
                <p>Enter your API token to access relay controls and advanced features:</p>
                <input type="password" id="authToken" placeholder="Enter API token" class="auth-input input-field">
                <div class="auth-buttons">
                    <button class="btn btn-primary" id="authenticateBtn">Authenticate</button>
                    <button class="btn btn-secondary" id="cancelAuthBtn">Cancel</button>
                </div>
                <div class="auth-help">
                    <small>Token is stored locally and encrypted. Check your system configuration for the API token.</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Tooltip -->
    <div class="tooltip" id="tooltip"></div>

    <!-- Rule Editor Modal -->
    <div class="modal-overlay" id="ruleModal" style="display: none;">
        <div class="modal-content modal-large">
            <div class="modal-header">
                <h3 id="ruleModalTitle">Nueva Regla</h3>
                <button class="modal-close" id="ruleModalClose">×</button>
            </div>
            <div class="modal-body">
                <form id="ruleForm">
                    <!-- Rule name -->
                    <div class="form-group">
                        <label for="ruleName">Nombre de la regla:</label>
                        <input type="text" id="ruleName" class="input-field" placeholder="ej: Riego matutino" required>
                    </div>

                    <!-- Conditions -->
                    <div class="form-group">
                        <label>Condiciones (todas deben cumplirse):</label>
                        <div id="conditionsList" class="conditions-list">
                            <!-- Conditions will be added dynamically -->
                        </div>
                        <button type="button" class="btn btn-secondary" id="addConditionBtn">+ Agregar Condición</button>
                    </div>

                    <!-- Action -->
                    <div class="form-group">
                        <label>Acción:</label>
                        <select id="ruleAction" class="input-field">
                            <option value="turn_on">Encender</option>
                            <option value="turn_off">Apagar</option>
                        </select>
                        <div id="actionDuration" style="margin-top:0.5rem;">
                            <label for="ruleDuration">Durante (minutos):</label>
                            <input type="number" id="ruleDuration" class="input-field" min="0" placeholder="0 = hasta condición contraria">
                        </div>
                    </div>

                    <!-- Advanced options (collapsible) -->
                    <details class="form-group">
                        <summary style="cursor:pointer; font-weight:600;">Opciones avanzadas</summary>
                        <div style="margin-top:1rem;">
                            <label for="rulePriority">Prioridad (1=máxima):</label>
                            <input type="number" id="rulePriority" class="input-field" min="1" max="10" value="5">
                            
                            <label for="ruleCooldown" style="margin-top:0.5rem;">Cooldown (min):</label>
                            <input type="number" id="ruleCooldown" class="input-field" min="0" value="0" placeholder="Tiempo mínimo entre activaciones">
                        </div>
                    </details>

                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" id="cancelRuleBtn">Cancelar</button>
                        <button type="submit" class="btn btn-primary">Guardar Regla</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Condition Builder Modal (sub-modal for adding conditions) -->
    <div class="modal-overlay" id="conditionModal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Agregar Condición</h3>
                <button class="modal-close" id="conditionModalClose">×</button>
            </div>
            <div class="modal-body">
                <form id="conditionForm">
                    <div class="form-group">
                        <label for="conditionType">Tipo de condición:</label>
                        <select id="conditionType" class="input-field">
                            <option value="time_range">Hora del día</option>
                            <option value="weekday">Día de la semana</option>
                            <option value="sensor">Sensor (temp/humedad)</option>
                            <option value="relay_state">Estado de relay</option>
                        </select>
                    </div>

                    <!-- Time range fields -->
                    <div id="timeRangeFields" class="condition-fields" style="display:none;">
                        <label for="timeStart">Desde:</label>
                        <input type="time" id="timeStart" class="input-field">
                        <label for="timeEnd">Hasta:</label>
                        <input type="time" id="timeEnd" class="input-field">
                    </div>

                    <!-- Weekday fields -->
                    <div id="weekdayFields" class="condition-fields" style="display:none;">
                        <label>Días:</label>
                        <div class="weekday-selector">
                            <label><input type="checkbox" value="1"> L</label>
                            <label><input type="checkbox" value="2"> M</label>
                            <label><input type="checkbox" value="3"> X</label>
                            <label><input type="checkbox" value="4"> J</label>
                            <label><input type="checkbox" value="5"> V</label>
                            <label><input type="checkbox" value="6"> S</label>
                            <label><input type="checkbox" value="0"> D</label>
                        </div>
                    </div>

                    <!-- Sensor fields -->
                    <div id="sensorFields" class="condition-fields" style="display:none;">
                        <label for="sensorType">Sensor:</label>
                        <select id="sensorType" class="input-field">
                            <option value="temperature">Temperatura</option>
                            <option value="humidity">Humedad ambiente</option>
                            <option value="soil_moisture_1">Humedad suelo 1</option>
                            <option value="soil_moisture_2">Humedad suelo 2</option>
                        </select>
                        <label for="sensorOp">Operador:</label>
                        <select id="sensorOp" class="input-field">
                            <option value="<">Menor que</option>
                            <option value=">">Mayor que</option>
                            <option value="=">Igual a</option>
                            <option value="between">Entre</option>
                        </select>
                        <label for="sensorValue">Valor:</label>
                        <input type="number" id="sensorValue" class="input-field" step="0.1">
                        <div id="sensorValueMax" style="display:none; margin-top:0.5rem;">
                            <label for="sensorValue2">y:</label>
                            <input type="number" id="sensorValue2" class="input-field" step="0.1">
                        </div>
                    </div>

                    <!-- Relay state fields -->
                    <div id="relayStateFields" class="condition-fields" style="display:none;">
                        <label for="relayIndex">Relay:</label>
                        <select id="relayIndex" class="input-field">
                            <option value="0">Luces</option>
                            <option value="1">Ventilador</option>
                            <option value="2">Bomba</option>
                            <option value="3">Calefactor</option>
                        </select>
                        <label for="relayStateOp">Estado:</label>
                        <select id="relayStateOp" class="input-field">
                            <option value="on">Encendido</option>
                            <option value="off">Apagado</option>
                            <option value="on_duration">Encendido hace (min)</option>
                            <option value="off_duration">Apagado hace (min)</option>
                        </select>
                        <div id="relayDurationField" style="display:none; margin-top:0.5rem;">
                            <label for="relayDuration">Minutos:</label>
                            <input type="number" id="relayDuration" class="input-field" min="0">
                        </div>
                    </div>

                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" id="cancelConditionBtn">Cancelar</button>
                        <button type="submit" class="btn btn-primary">Agregar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="/relay_manager.js"></script>
    <script src="/script.js"></script>
</body>
</html>